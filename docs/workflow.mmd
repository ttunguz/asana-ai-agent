graph TB
    Start([Agent Daemon Starts]) --> LoadConfig[Load config.yml]
    LoadConfig --> ValidateConfig{Validate<br/>Configuration}
    ValidateConfig -->|Invalid| ConfigError[Show Configuration Errors]
    ValidateConfig -->|Valid| InitMonitor[Initialize Agent Monitor]

    InitMonitor --> InitLLM[Initialize LLM Clients]
    InitLLM --> PollLoop{Poll Asana Tasks<br/>Every N Seconds}

    PollLoop --> FetchTasks[Fetch Incomplete Tasks<br/>from Project]
    FetchTasks --> FilterProcessed{Filter Already<br/>Processed Tasks}

    FilterProcessed --> CheckNewTasks{New Tasks<br/>Found?}
    CheckNewTasks -->|No| CheckComments{Comment<br/>Monitoring?}
    CheckNewTasks -->|Yes| RouteWorkflow[Route to Workflow]

    CheckComments -->|Disabled| Sleep[Sleep Poll Interval]
    CheckComments -->|Enabled| FetchComments[Fetch New Comments]
    FetchComments --> CheckNewComments{New Comments?}
    CheckNewComments -->|No| Sleep
    CheckNewComments -->|Yes| RouteComment[Route Comment to Workflow]

    RouteWorkflow --> ClassifyTask[Classify Task Intent<br/>Using LLM]
    RouteComment --> ClassifyTask

    ClassifyTask --> SelectWorkflow{Select Workflow<br/>Based on Keywords}

    SelectWorkflow -->|search, find, shopping| GeneralSearch[General Search Workflow]
    SelectWorkflow -->|summarize, summary| ArticleSummary[Article Summary Workflow]
    SelectWorkflow -->|email, draft| EmailDraft[Email Draft Workflow]
    SelectWorkflow -->|newsletter| NewsletterSummary[Newsletter Summary Workflow]
    SelectWorkflow -->|url, link| OpenURL[Open URL Workflow]

    GeneralSearch --> ExecuteWorkflow[Execute Workflow<br/>with Selected LLM]
    ArticleSummary --> ExecuteWorkflow
    EmailDraft --> ExecuteWorkflow
    NewsletterSummary --> ExecuteWorkflow
    OpenURL --> ExecuteWorkflow

    ExecuteWorkflow --> LLMProvider{Which LLM<br/>Provider?}

    LLMProvider -->|Configured| Gemini[Gemini Client]
    LLMProvider -->|Configured| Claude[Claude Client]
    LLMProvider -->|Configured| OpenAI[OpenAI Client]
    LLMProvider -->|Configured| Perplexity[Perplexity Client]

    Gemini --> GenerateResponse[Generate AI Response]
    Claude --> GenerateResponse
    OpenAI --> GenerateResponse
    Perplexity --> GenerateResponse

    GenerateResponse --> CreateResultTask[Create Result Task<br/>for User]
    CreateResultTask --> AddComment[Add Summary Comment<br/>to Original Task]
    AddComment --> MarkProcessed[Mark Task as Processed<br/>in processed_tasks.json]

    MarkProcessed --> Sleep
    Sleep --> PollLoop

    ConfigError --> Exit([Exit with Error])

    style Start fill:#90EE90
    style Exit fill:#FFB6C1
    style ClassifyTask fill:#FFE4B5
    style ExecuteWorkflow fill:#FFE4B5
    style GenerateResponse fill:#87CEEB
    style CreateResultTask fill:#DDA0DD
